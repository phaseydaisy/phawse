<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Upload</title>
  <link rel="stylesheet" href="/uploadv/styles.css">
</head>
<body>
  <main class="container">
    <section class="hero-section">
      <div class="profile-badge">Uploads</div>
      <h1 class="hero-title">Share Clips</h1>
      <p class="muted">Get a shareable URL that Discord will embed when pasted in chat.</p>
    </section>

    <section class="card" id="uploader">
      <form id="uploadForm" class="form">
        <label class="field">Title
          <input class="input" name="title" placeholder="Optional title (used in embed)" maxlength="200">
        </label>

        <label class="field">Description
          <textarea class="textarea" name="description" rows="3" placeholder="Short description (shown in embeds)" maxlength="500"></textarea>
        </label>

        <label class="field">Public URL
          <input class="input" name="siteurl" placeholder="Optional public base URL where you'll host (e.g. https://example.com)">
        </label>

        <label class="field">
          <div id="dropzone" class="dropzone" tabindex="0">
            <input id="videoInput" class="input" type="file" name="video" accept="video/*" style="display:none">
            <div class="dropzone-inner">
              <div class="drop-icon">ðŸ“¤</div>
              <div><strong id="dropLabel">Drag & drop a video here</strong></div>
              <div><button type="button" id="chooseFile" class="btn">Choose a file</button></div>
              <div id="fileInfo" class="note" aria-live="polite"></div>
            </div>
          </div>
        </label>

        <div class="actions">
          <button class="btn" type="submit">Upload</button>
          <button class="btn" id="downloadPackage" type="button" title="Create a downloadable package you can host anywhere">Download package</button>
          <button class="btn ghost" type="reset">Reset</button>
        </div>

        <div class="progress" id="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>
        <div id="progressText" class="note" aria-live="polite"></div>
      </form>

      <div id="result" class="result" aria-live="polite" role="status"></div>

<script>
const EXPORT_TEMPLATE = `<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <title>{TITLE} â€” Clip</title>
  <meta property="og:title" content="{TITLE}">
  <meta property="og:description" content="{DESCRIPTION}">
  <meta property="og:type" content="video.other">
  <meta property="og:image" content="{SITE_URL}/uploadv/{slug}/thumb.jpg">
  <meta property="og:video" content="{SITE_URL}/uploadv/{slug}/video.mp4">
  <meta property="og:video:secure_url" content="{SITE_URL}/uploadv/{slug}/video.mp4">
  <meta property="og:video:type" content="video/mp4">
  <meta property="og:video:width" content="1280">
  <meta property="og:video:height" content="720">
  <link rel="canonical" href="{SITE_URL}/uploadv/{slug}/">

  <meta name="twitter:card" content="player">
  <meta name="twitter:title" content="{TITLE}">
  <meta name="twitter:description" content="{DESCRIPTION}">
  <meta name="twitter:image" content="{SITE_URL}/uploadv/{slug}/thumb.jpg">
  <meta name="twitter:player" content="{SITE_URL}/uploadv/{slug}/index.html">
  <meta name="twitter:player:width" content="1280">
  <meta name="twitter:player:height" content="720">

  <style>body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:1rem;display:grid;gap:1rem;max-inline-size:900px;margin-inline-start:auto;margin-inline-end:auto}video{max-inline-size:100%;block-size:auto;border:1px solid #ddd;border-radius:6px}</style>
</head>
<body>
  <h1>{TITLE}</h1>
  <p>{DESCRIPTION}</p>

  <video src="video.mp4" controls poster="thumb.jpg">Your browser does not support the video element.</video>

  <p style="font-size:.9rem;color:#666">Share <a href="{SITE_URL}/uploadv/{slug}/">{SITE_URL}/uploadv/{slug}/</a> to embed this clip in Discord.</p>
</body>
</html>`;

function loadJSZip() {
  if (window.JSZip) return Promise.resolve(window.JSZip);
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js';
    s.onload = () => resolve(window.JSZip);
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

const dropzone = document.getElementById('dropzone');
const videoInput = document.getElementById('videoInput');
const chooseFile = document.getElementById('chooseFile');
const dropLabel = document.getElementById('dropLabel');
const fileInfo = document.getElementById('fileInfo');
const progressText = document.getElementById('progressText');
const form = document.getElementById('uploadForm');
const result = document.getElementById('result');
const progress = document.getElementById('progress');
const bar = document.getElementById('bar');
let selectedVideo = null;
const downloadPackage = document.getElementById('downloadPackage');

function formatBytes(bytes){if(bytes===0)return'0 B';const k=1024;const dm=1;const sizes=['B','KB','MB','GB'];const i=Math.floor(Math.log(bytes)/Math.log(k));return parseFloat((bytes/Math.pow(k,i)).toFixed(dm))+' '+sizes[i]}

chooseFile.addEventListener('click',()=>videoInput.click());

dropzone.addEventListener('dragover',(e)=>{e.preventDefault();dropzone.classList.add('dragover');dropLabel.textContent='Release to upload'});

dropzone.addEventListener('dragleave',()=>{dropzone.classList.remove('dragover');dropLabel.textContent='Drag & drop a video here'});

dropzone.addEventListener('drop',(e)=>{e.preventDefault();dropzone.classList.remove('dragover');dropLabel.textContent='Drag & drop a video here';const f=(e.dataTransfer.files&&e.dataTransfer.files[0]);if(f){selectedVideo = f;fileInfo.textContent = f.name + ' â€¢ ' + formatBytes(f.size)}});

videoInput.addEventListener('change',()=>{const f=videoInput.files[0];if(f){selectedVideo = f;fileInfo.textContent = f.name + ' â€¢ ' + formatBytes(f.size)}});

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  result.textContent = '';
  if (!selectedVideo) { result.textContent = 'Please choose a video file first.'; return }

  progress.style.display = 'block';
  bar.style.width = '0%';
  progressText.textContent = 'Starting upload...';

  const fd = new FormData();
  const titleField = form.querySelector('[name="title"]');
  if (titleField && titleField.value) fd.append('title', titleField.value);
  const descField = form.querySelector('[name="description"]');
  if (descField && descField.value) fd.append('description', descField.value);
  fd.append('video', selectedVideo, selectedVideo.name);

    try {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/uploadv/api/upload', true);
    xhr.timeout = 60 * 1000; // 60s
    let startTime = Date.now();
    xhr.upload.onprogress = (ev) => {
      if (ev.lengthComputable) {
        const pct = Math.round(ev.loaded / ev.total * 100);
        bar.style.width = pct + '%';
        const now = Date.now();
        const seconds = Math.max(0.001, (now - startTime) / 1000);
        const speed = (ev.loaded / seconds);
        const speedText = (speed / 1024).toFixed(1) + ' KB/s';
        progressText.textContent = pct + '% â€” ' + speedText;
      }
    };
    xhr.onload = () => {
      progress.style.display = 'none';
      progressText.textContent = '';
      if (xhr.status >= 200 && xhr.status < 300) {
        const data = JSON.parse(xhr.responseText);
        result.innerHTML = `Created: <a href="${data.url}" target="_blank" rel="noopener">${data.url}</a> <button id="copy">Copy</button>`;
        document.getElementById('copy').addEventListener('click',()=>navigator.clipboard.writeText(data.url));
        form.reset();
        selectedVideo = null;
        fileInfo.textContent = '';
        bar.style.width = '0%';
      } else {
        result.textContent = 'Upload failed: ' + (xhr.responseText || (xhr.status + ' ' + xhr.statusText));
      }
    };
    xhr.onerror = ()=>{
      progress.style.display='none';
      progressText.textContent='';
      result.textContent='Upload failed: network error â€” is the upload server running? Try `npm run start:upload` in the project root.';
      console.error('Upload error', xhr.status, xhr.statusText);
    };
    xhr.ontimeout = ()=>{
      progress.style.display='none';
      progressText.textContent='';
      result.textContent='Upload failed: request timed out â€” the server may be unreachable.';
      console.error('Upload timed out');
    };
    xhr.send(fd);
  } catch (err) {
    progress.style.display = 'none';
    result.textContent = 'Upload failed: ' + err.message;
  }
});

  downloadPackage.addEventListener('click', async () => {
    result.textContent = '';
    if (!selectedVideo) { result.textContent = 'Please choose a video file first.'; return }
    downloadPackage.disabled = true;
    downloadPackage.textContent = 'Preparing...';

    try {
      await loadJSZip();
      const zip = new JSZip();

      const titleField = form.querySelector('[name="title"]');
      const descField = form.querySelector('[name="description"]');
      const siteField = form.querySelector('[name="siteurl"]');
      const title = (titleField && titleField.value) ? titleField.value : 'Untitled';
      const description = (descField && descField.value) ? descField.value : '';
      const slug = (title ? title.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'').slice(0,60) : '') || Math.random().toString(36).slice(2,10);
      let siteUrl = (siteField && siteField.value) ? siteField.value.trim() : '';
      if (!siteUrl) siteUrl = (location.protocol === 'http:' || location.protocol === 'https:') ? location.origin : 'https://example.com';
      siteUrl = siteUrl.replace(/\/$/, '');

      const page = EXPORT_TEMPLATE.replace(/\{SITE_URL\}/g, siteUrl).replace(/\{TITLE\}/g, escapeHtml(title)).replace(/\{DESCRIPTION\}/g, escapeHtml(description)).replace(/\{slug\}/g, slug);

      zip.file('index.html', page);
      const buf = await selectedVideo.arrayBuffer();
      const ext = selectedVideo.name.split('.').pop().toLowerCase();
      const videoName = 'video.' + (ext || 'mp4');
      zip.file(videoName, buf);

      const content = await zip.generateAsync({ type: 'blob' }, (metadata) => {
        progress.style.display = 'block';
        const pct = Math.round(metadata.percent);
        bar.style.width = pct + '%';
        progressText.textContent = 'Packaging: ' + pct + '%';
      });

      const a = document.createElement('a');
      a.href = URL.createObjectURL(content);
      a.download = (slug || 'clip') + '.zip';
      document.body.appendChild(a);
      a.click();
      a.remove();
      progress.style.display = 'none';
      progressText.textContent = '';
      const shareUrl = siteUrl + '/' + slug + '/';
      result.innerHTML = `Package ready â€” <a href="${shareUrl}" target="_blank" rel="noopener">${shareUrl}</a> <button id="copyLink">Copy link</button>`;
      document.getElementById('copyLink').addEventListener('click', ()=>navigator.clipboard.writeText(shareUrl));
    } catch (err) {
      console.error(err);
      result.textContent = 'Failed to create package: ' + (err.message || err);
    } finally {
      downloadPackage.disabled = false;
      downloadPackage.textContent = 'Download package';
      bar.style.width = '0%';
    }
  });
</script>
    </section>

    <footer class="footer muted">Tip: use a short title â€” the URL will use it to generate the path (e.g. <code>/uploadv/my-clip/</code>).</footer>
  </main>
</body>
</html>