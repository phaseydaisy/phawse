<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Upload</title>
  <link rel="stylesheet" href="/uploadv/styles.css">
</head>
<body>
  <main class="container">
    <section class="hero-section">
      <div class="profile-badge">Uploads</div>
      <h1 class="hero-title">Share Clips</h1>
      <p class="muted">Get a shareable URL that Discord will embed when pasted in chat.</p>
    </section>

    <section class="card" id="uploader">
      <form id="uploadForm" class="form">
        <label class="field">Title
          <input class="input" name="title" placeholder="Optional title (used in embed)" maxlength="200">
        </label>

        <label class="field">Description
          <textarea class="textarea" name="description" rows="3" placeholder="Short description (shown in embeds)" maxlength="500"></textarea>
        </label>

        <label class="field">
          <div id="dropzone" class="dropzone" tabindex="0">
            <input id="videoInput" class="input" type="file" name="video" accept="video/*" style="display:none">
            <div class="dropzone-inner">
              <div class="drop-icon">ðŸ“¤</div>
              <div><strong id="dropLabel">Drag & drop a video here</strong></div>
              <div><button type="button" id="chooseFile" class="btn">Choose a file</button></div>
              <div id="fileInfo" class="note" aria-live="polite"></div>
            </div>
          </div>
        </label>

        <div class="actions">
          <button class="btn" type="submit">Upload</button>
          <button class="btn ghost" type="reset">Reset</button>
        </div>

        <div class="progress" id="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>
        <div id="progressText" class="note" aria-live="polite"></div>
      </form>

      <div id="result" class="result" aria-live="polite" role="status"></div>

<script>
const dropzone = document.getElementById('dropzone');
const videoInput = document.getElementById('videoInput');
const chooseFile = document.getElementById('chooseFile');
const dropLabel = document.getElementById('dropLabel');
const fileInfo = document.getElementById('fileInfo');
const progressText = document.getElementById('progressText');
const form = document.getElementById('uploadForm');
const result = document.getElementById('result');
const progress = document.getElementById('progress');
const bar = document.getElementById('bar');
let selectedVideo = null;

function formatBytes(bytes){if(bytes===0)return'0 B';const k=1024;const dm=1;const sizes=['B','KB','MB','GB'];const i=Math.floor(Math.log(bytes)/Math.log(k));return parseFloat((bytes/Math.pow(k,i)).toFixed(dm))+' '+sizes[i]}

chooseFile.addEventListener('click',()=>videoInput.click());

dropzone.addEventListener('dragover',(e)=>{e.preventDefault();dropzone.classList.add('dragover');dropLabel.textContent='Release to upload'});

dropzone.addEventListener('dragleave',()=>{dropzone.classList.remove('dragover');dropLabel.textContent='Drag & drop a video here'});

dropzone.addEventListener('drop',(e)=>{e.preventDefault();dropzone.classList.remove('dragover');dropLabel.textContent='Drag & drop a video here';const f=(e.dataTransfer.files&&e.dataTransfer.files[0]);if(f){selectedVideo = f;fileInfo.textContent = f.name + ' â€¢ ' + formatBytes(f.size)}});

videoInput.addEventListener('change',()=>{const f=videoInput.files[0];if(f){selectedVideo = f;fileInfo.textContent = f.name + ' â€¢ ' + formatBytes(f.size)}});

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  result.textContent = '';
  if (!selectedVideo) { result.textContent = 'Please choose a video file first.'; return }

  progress.style.display = 'block';
  bar.style.width = '0%';
  progressText.textContent = 'Starting upload...';

  const fd = new FormData();
  const titleField = form.querySelector('[name="title"]');
  if (titleField && titleField.value) fd.append('title', titleField.value);
  const descField = form.querySelector('[name="description"]');
  if (descField && descField.value) fd.append('description', descField.value);
  fd.append('video', selectedVideo, selectedVideo.name);

  try {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/uploadv/api/upload', true);
    let startTime = Date.now();
    xhr.upload.onprogress = (ev) => {
      if (ev.lengthComputable) {
        const pct = Math.round(ev.loaded / ev.total * 100);
        bar.style.width = pct + '%';
        const now = Date.now();
        const seconds = Math.max(0.001, (now - startTime) / 1000);
        const speed = (ev.loaded / seconds);
        const speedText = (speed / 1024).toFixed(1) + ' KB/s';
        progressText.textContent = pct + '% â€” ' + speedText;
      }
    };
    xhr.onload = () => {
      progress.style.display = 'none';
      progressText.textContent = '';
      if (xhr.status >= 200 && xhr.status < 300) {
        const data = JSON.parse(xhr.responseText);
        result.innerHTML = `Created: <a href="${data.url}" target="_blank" rel="noopener">${data.url}</a> <button id="copy">Copy</button>`;
        document.getElementById('copy').addEventListener('click',()=>navigator.clipboard.writeText(data.url));
        form.reset();
        selectedVideo = null;
        fileInfo.textContent = '';
        bar.style.width = '0%';
      } else {
        result.textContent = 'Upload failed: ' + xhr.responseText;
      }
    };
    xhr.onerror = ()=>{progress.style.display='none';progressText.textContent='';result.textContent='Upload failed: network error'};
    xhr.send(fd);
  } catch (err) {
    progress.style.display = 'none';
    result.textContent = 'Upload failed: ' + err.message;
  }
});
</script>
    </section>

    <footer class="footer muted">Tip: use a short title â€” the URL will use it to generate the path (e.g. <code>/uploadv/my-clip/</code>).</footer>
  </main>
</body>
</html>